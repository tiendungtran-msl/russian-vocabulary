<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trắc nghiệm từ vựng tiếng Nga</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            animation: fadeInDown 1s ease-out;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            animation: fadeInUp 1s ease-out;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            animation: slideInUp 0.8s ease-out;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .section.active {
            display: block;
        }

        .file-upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: linear-gradient(45deg, #f8f9ff, #e8ecff);
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: #764ba2;
            background: linear-gradient(45deg, #f0f2ff, #dde1ff);
            transform: translateY(-2px);
        }

        .file-upload-area.dragover {
            border-color: #4CAF50;
            background: linear-gradient(45deg, #f0fff4, #e8f5e8);
        }

        .upload-icon {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .btn-success:hover {
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
        }

        .chapter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .chapter-card {
            background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
            border: 2px solid #e0e8ff;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .chapter-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s;
        }

        .chapter-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }

        .chapter-card:hover::before {
            left: 100%;
        }

        .chapter-card.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .quiz-container {
            text-align: center;
            padding: 40px 20px;
        }

        .question {
            background: linear-gradient(135deg, #f8f9ff, #e8ecff);
            border-radius: 20px;
            padding: 40px;
            margin: 30px 0;
            font-size: 1.8em;
            font-weight: 600;
            color: #333;
            border-left: 5px solid #667eea;
            animation: slideInLeft 0.5s ease-out;
        }

        .russian-text {
            font-size: 2.5em;
            color: #764ba2;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }

        .option {
            background: linear-gradient(135deg, #fff, #f0f2ff);
            border: 2px solid #e0e8ff;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2em;
            font-weight: 500;
            position: relative;
            overflow: hidden;
            /* Thêm flexbox để căn giữa */
            display: flex;
            justify-content: center; /* Căn giữa theo chiều ngang */
            align-items: center; /* Căn giữa theo chiều dọc */
            text-align: center; /* Đảm bảo văn bản căn giữa nếu có nhiều dòng */
        }

        .option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.3s;
        }

        .option:hover {
            transform: translateY(-3px);
            border-color: #667eea;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
        }

        .option:hover::before {
            left: 100%;
        }

        .option.correct {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border-color: #4CAF50;
        }

        .option.incorrect {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border-color: #ff6b6b;
        }

        .score-display {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            text-align: center;
            font-size: 1.5em;
            font-weight: 600;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .progress-bar {
            background: #e0e8ff;
            border-radius: 25px;
            height: 20px;
            margin: 20px 0;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            height: 100%;
            border-radius: 25px;
            transition: width 0.5s ease;
            box-shadow: 0 2px 10px rgba(76, 175, 80, 0.3);
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .file-list {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e0e8ff;
            animation: slideInRight 0.3s ease-out;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-name {
            font-weight: 600;
            color: #333;
        }

        .word-count {
            color: #667eea;
            font-size: 0.9em;
        }

        /* Review button (fixed top-right) */
        #openReviewBtn {
            position: fixed;
            top: 18px;
            right: 18px;
            z-index: 1200;
            display: none;
            padding: 10px 14px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
        }
        /* Review panel overlay */
        #reviewPanel {
            position: fixed;
            top: 60px;
            right: 20px;
            width: 360px;
            max-height: calc(100vh - 120px);
            overflow: auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.25);
            padding: 12px;
            z-index: 1300;
            display: none;
        }
        #reviewPanel h3 { margin: 6px 0 10px 0; font-size: 1.05em; color:#333; }
        .review-item { padding:8px; border-bottom:1px solid #f0f4ff; display:flex; gap:8px; align-items:center; }
        .review-item .meta { flex:1; font-size:0.95em; }
        .review-item .meta .rus { font-weight:600; color:#764ba2; }
        .review-item .meta .kor { color:#2e7d32; font-size:0.92em; }
        .review-action { display:flex; gap:6px; }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(100px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 0.6s ease-in-out;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .main-card {
                padding: 20px;
            }
            
            .chapter-grid {
                grid-template-columns: 1fr;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
            
            .russian-text {
                font-size: 2em;
            }
            
            .navigation {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button id="openReviewBtn" class="btn" onclick="showReviewPanel()">📝 Từ trả lời sai</button>
        <div class="header">
            <h1>Тrắc nghiệm từ vựng tiếng Nga</h1>
            <p>Nâng cao kỹ năng từ vựng tiếng Nga của bạn một cách thú vị!</p>
        </div>

        <div class="main-card">
            <!-- Data Loading Section -->
            <div id="uploadSection" class="section active">
                <h2 style="text-align: center; margin-bottom: 30px; color: #333;">📚 Tải dữ liệu từ vựng</h2>
                
                <div class="file-upload-area" onclick="loadDataFromFolder()">
                    <div class="upload-icon">🔄</div>
                    <h3>Nhấn để tải lại dữ liệu</h3>
                    <p>Chúc bạn làm bài tốt</p>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #666;">Liên hệ dungtrantien2k3@gmail.com để báo lỗi từ vựng</p>
                </div>
                
                <div id="loadingIndicator" style="display: none; text-align: center; margin: 20px 0;">
                    <div style="font-size: 2em; color: #667eea;">🔄</div>
                    <p>Đang tải dữ liệu...</p>
                </div>
                
                <div id="fileList" class="file-list" style="display: none;">
                    <h3>📋 Danh sách file đã tải:</h3>
                    <div id="fileItems"></div>
                </div>
                
                <div class="navigation">
                    <button class="btn" onclick="startQuiz()" id="startQuizBtn" style="display: none;">
                        🎯 Bắt đầu luyện tập
                    </button>
                    <button class="btn btn-secondary" onclick="loadDataFromFolder()" id="reloadBtn" style="display: none;">
                        🔄 Tải lại dữ liệu
                    </button>
                </div>
            </div>

            <!-- Chapter Selection Section -->
            <div id="chapterSection" class="section">
                <h2 style="text-align: center; margin-bottom: 30px; color: #333;">📖 Chọn chương để luyện tập</h2>
                
                <div id="chapterGrid" class="chapter-grid"></div>
                
                <div class="navigation">
                    <button class="btn btn-secondary" onclick="showSection('uploadSection')">
                        ⬅️ Trở về
                    </button>
                    <button class="btn btn-success" onclick="startSelectedQuiz()" id="startSelectedBtn" style="display: none;">
                        🚀 Bắt đầu quiz
                    </button>
                </div>
            </div>

            <!-- Quiz Section -->
            <div id="quizSection" class="section">
                <div class="score-display">
                    <div>Câu hỏi: <span id="questionNum">1</span>/<span id="totalQuestions">10</span></div>
                    <div>Điểm: <span id="currentScore">0</span>/<span id="maxScore">0</span></div>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                </div>
                
                <div class="quiz-container">
                    <div class="question">
                        <div>Từ tiếng Nga này có nghĩa là gì?</div>
                        <div class="russian-text" id="russianWord"></div>
                    </div>
                    
                    <div class="options-grid" id="optionsGrid"></div>
                </div>
                
                <div class="navigation">
                    <button class="btn btn-secondary" onclick="endQuiz()">
                        ❌ Kết thúc
                    </button>
                    <button class="btn" onclick="nextQuestion()" id="nextBtn" style="display: none;">
                        ➡️ Câu tiếp theo
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="section">
                <div style="text-align: center;">
                    <h2 style="margin-bottom: 30px; color: #333;">🎉 Kết quả</h2>
                    
                    <div class="score-display">
                        <div style="font-size: 2em; margin-bottom: 20px;" id="finalScore"></div>
                        <div id="scoreMessage"></div>
                    </div>
                    
                    <div id="wrongAnswers" style="background: #f8f9ff; border-radius: 15px; padding: 20px; margin: 30px 0; text-align: left;"></div>
                    
                    <div class="navigation">
                        <button class="btn btn-secondary" onclick="showSection('chapterSection')">
                            📖 Chọn chương khác
                        </button>
                        <button class="btn" onclick="restartQuiz()">
                            🔄 Làm lại quiz
                        </button>
                    </div>
                </div>
            </div>
            <!-- Review Panel (floating) -->
            <div id="reviewPanel" aria-hidden="true">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>📝 Danh sách từ sai</h3>
                    <div>
                        <button class="btn btn-success" onclick="clearAllReview()" style="padding:6px 10px">Xóa tất cả</button>
                        <button class="btn btn-secondary" onclick="hideReviewPanel()" style="padding:6px 10px; margin-left:6px">Đóng</button>
                    </div>
                </div>
                <div id="reviewListContainer" style="margin-top:8px;"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let vocabularyData = {};
        let currentChapter = '';
        let currentQuiz = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let wrongAnswers = [];
        let selectedChapters = [];

// New persistent review store
const REVIEW_KEY = 'tuvung_review_v1';
let reviewList = loadReviewList();

function loadReviewList() {
    try {
        const s = localStorage.getItem(REVIEW_KEY);
        return s ? JSON.parse(s) : [];
    } catch (e) { return []; }
}
function saveReviewList() {
    try { localStorage.setItem(REVIEW_KEY, JSON.stringify(reviewList)); } catch (e) {}
}
function makeId(){ return Date.now().toString(36) + Math.floor(Math.random()*1000).toString(36); }

/* Add or update an entry when user trả lời sai */
function addPersistentWrong({ russian, correct, selected }) {
    const key = russian + '||' + correct;
    const now = Date.now();
    const idx = reviewList.findIndex(it => (it.russian + '||' + it.correct) === key);
    if (idx >= 0) {
        const it = reviewList[idx];
        it.count = (it.count || 1) + 1;
        it.selected = selected;
        it.lastSeen = now;
        it.known = false;
        // move to front
        reviewList.splice(idx, 1);
        reviewList.unshift(it);
    } else {
        reviewList.unshift({
            id: makeId(),
            russian, correct, selected,
            count: 1,
            firstSeen: now,
            lastSeen: now,
            known: false
        });
    }
    saveReviewList();
    // show review button if at least one item
    const openBtn = document.getElementById('openReviewBtn');
    if (openBtn) openBtn.style.display = reviewList.length ? 'inline-block' : 'none';
}

/* Render review panel */
function renderReviewList() {
    const container = document.getElementById('reviewListContainer');
    if (!container) return;
    if (reviewList.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#666;">Không có từ nào trong danh sách.</div>';
        return;
    }
    let html = '';
    reviewList.forEach(it => {
        const t = new Date(it.lastSeen).toLocaleString();
        html += `<div class="review-item" data-id="${it.id}">
            <div class="meta">
                <div class="rus">${escapeHtml(it.russian)}</div>
                <div class="kor">✓ ${escapeHtml(it.correct)} · Bạn: ${escapeHtml(it.selected)} · ${it.count}×</div>
                <div style="font-size:0.8em; color:#888;">${t}</div>
            </div>
            <div class="review-action">
                <button class="btn" onclick="markAsKnown('${it.id}')" title="Đã thuộc">Đã thuộc</button>
                <button class="btn btn-secondary" onclick="removeReviewItem('${it.id}')" title="Xóa">Xóa</button>
            </div>
        </div>`;
    });
    container.innerHTML = html;
}

/* Mark item as known (remove from list) */
function markAsKnown(id) {
    reviewList = reviewList.filter(i => i.id !== id);
    saveReviewList();
    renderReviewList();
}

/* Remove single item */
function removeReviewItem(id) {
    reviewList = reviewList.filter(i => i.id !== id);
    saveReviewList();
    renderReviewList();
}

/* Clear all review items */
function clearAllReview() {
    if (!confirm('Xóa toàn bộ danh sách từ sai?')) return;
    reviewList = [];
    saveReviewList();
    renderReviewList();
    hideReviewPanel();
}

/* Show/hide panel */
function showReviewPanel() {
    renderReviewList();
    const panel = document.getElementById('reviewPanel');
    if (panel) panel.style.display = 'block';
}
function hideReviewPanel() {
    const panel = document.getElementById('reviewPanel');
    if (panel) panel.style.display = 'none';
}

/* escape helper */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

        // Data file names - update this array when adding new files
        const dataFiles = [
            'Chuong1.txt',
            'Baitap1.txt',
            'Chuong2.txt',
            'Baitap2.txt',
            'Chuong3.txt',
            'Baitap3.txt',
            'Chuong4.txt',
            'Baitap4.txt',
            'Chuong5.txt',
            'Baitap5.txt',
            'Chuong6.txt',
            'Baitap6.txt',
            'Chuong7.txt'
            // Add more files as needed
        ];

        // Load data from folder
        async function loadDataFromFolder() {
            const fileList = document.getElementById('fileList');
            const fileItems = document.getElementById('fileItems');
            const startQuizBtn = document.getElementById('startQuizBtn');
            const reloadBtn = document.getElementById('reloadBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');

            // Show loading indicator
            loadingIndicator.style.display = 'block';
            fileList.style.display = 'none';
            vocabularyData = {};

            fileItems.innerHTML = '';
            let loadedFiles = 0;

            for (const fileName of dataFiles) {
                try {
                    const content = await loadFileFromServer(`data/${fileName}`);
                    if (content) {
                        const chapterName = fileName.replace('.txt', '');
                        const words = parseVocabulary(content);
                        
                        if (words.length > 0) {
                            vocabularyData[chapterName] = words;
                            
                            const fileItem = document.createElement('div');
                            fileItem.className = 'file-item';
                            fileItem.innerHTML = `
                                <span class="file-name">${fileName}</span>
                                <span class="word-count">${words.length} từ</span>
                            `;
                            fileItems.appendChild(fileItem);
                            loadedFiles++;
                        }
                    }
                } catch (error) {
                    console.log(`File ${fileName} not found or error loading:`, error);
                    // Continue with other files
                }
            }

            // Hide loading indicator
            loadingIndicator.style.display = 'none';

            if (loadedFiles > 0) {
                fileList.style.display = 'block';
                startQuizBtn.style.display = 'inline-block';
                reloadBtn.style.display = 'inline-block';
                // show review button if we have stored items
                const openBtn = document.getElementById('openReviewBtn');
                if (openBtn) openBtn.style.display = reviewList.length ? 'inline-block' : 'none';
                startQuizBtn.classList.add('pulse');
                setTimeout(() => startQuizBtn.classList.remove('pulse'), 600);
            } else {
                alert('Không tìm thấy file dữ liệu nào trong thư mục /data.\n\nHãy đảm bảo:\n1. Thư mục "data" nằm cùng cấp với file HTML\n2. Các file có định dạng .txt\n3. Tên file được liệt kê trong mảng dataFiles');
            }
        }

        // Load file from server
        async function loadFileFromServer(filePath) {
            try {
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.text();
            } catch (error) {
                console.log(`Could not load ${filePath}:`, error);
                return null;
            }
        }

        function parseVocabulary(content) {
            const lines = content.split('\n');
            const words = [];
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed && trimmed.includes(' - ')) {
                    const [russian, vietnamese] = trimmed.split(' - ').map(s => s.trim());
                    if (russian && vietnamese) {
                        words.push({ russian, vietnamese });
                    }
                }
            }
            
            return words;
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        function startQuiz() {
            displayChapters();
            showSection('chapterSection');
        }

        function displayChapters() {
            const chapterGrid = document.getElementById('chapterGrid');
            chapterGrid.innerHTML = '';
            
            for (const [chapterName, words] of Object.entries(vocabularyData)) {
                const chapterCard = document.createElement('div');
                chapterCard.className = 'chapter-card';
                chapterCard.innerHTML = `
                    <h3>${chapterName}</h3>
                    <p>${words.length} từ vựng</p>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #666;">Nhấn để chọn</p>
                `;
                
                chapterCard.addEventListener('click', () => toggleChapterSelection(chapterName, chapterCard));
                chapterGrid.appendChild(chapterCard);
            }
        }

        function toggleChapterSelection(chapterName, cardElement) {
            const startBtn = document.getElementById('startSelectedBtn');
            
            if (selectedChapters.includes(chapterName)) {
                selectedChapters = selectedChapters.filter(name => name !== chapterName);
                cardElement.classList.remove('selected');
            } else {
                selectedChapters.push(chapterName);
                cardElement.classList.add('selected');
            }
            
            if (selectedChapters.length > 0) {
                startBtn.style.display = 'inline-block';
                startBtn.classList.add('pulse');
                setTimeout(() => startBtn.classList.remove('pulse'), 600);
            } else {
                startBtn.style.display = 'none';
            }
        }

        function startSelectedQuiz() {
            if (selectedChapters.length === 0) return;
            const MAX_QUESTIONS = 20;

            // For single-chapter case (common), use that chapter's queue to get distinct words
            // For multiple chapters, we distribute round-robin across their queues
            let chosen = [];

            if (selectedChapters.length === 1) {
                const ch = selectedChapters[0];
                chosen = getNextFromChapter(ch, Math.min(MAX_QUESTIONS, (vocabularyData[ch]||[]).length));
            } else {
                // round-robin across selected chapters to keep even distribution
                let needed = Math.min(MAX_QUESTIONS, Object.values(selectedChapters).reduce((s, c) => s + (vocabularyData[c] ? vocabularyData[c].length : 0), 0));
                let idx = 0;
                while (chosen.length < needed) {
                    const ch = selectedChapters[idx % selectedChapters.length];
                    const next = getNextFromChapter(ch, 1);
                    if (next.length > 0) chosen.push(next[0]);
                    idx++;
                    // break if all queues empty
                    if (selectedChapters.every(c => !chapterQueues[c] || chapterQueues[c].length === 0) && chosen.length === 0) break;
                }
            }

            currentQuiz = chosen.slice(0, MAX_QUESTIONS);
            currentQuestionIndex = 0;
            score = 0;
            wrongAnswers = [];

            document.getElementById('totalQuestions').textContent = currentQuiz.length;
            document.getElementById('maxScore').textContent = currentQuiz.length;

            showSection('quizSection');
            displayQuestion();
        }

        // New: per-chapter shuffled queues to ensure even distribution
        const chapterQueues = {};

        // Refill queue for a chapter (shuffle once and store)
        function refillChapterQueue(chapter) {
            const words = vocabularyData[chapter] ? [...vocabularyData[chapter]] : [];
            chapterQueues[chapter] = shuffleArray(words);
        }

        // Get up to count distinct words from chapter queue (reshuffle if needed)
        function getNextFromChapter(chapter, count) {
            if (!chapterQueues[chapter] || chapterQueues[chapter].length === 0) {
                refillChapterQueue(chapter);
            }
            const result = [];
            while (result.length < count) {
                if (chapterQueues[chapter].length === 0) {
                    // exhausted: refill and continue to ensure coverage
                    refillChapterQueue(chapter);
                    if (chapterQueues[chapter].length === 0) break; // no words available
                }
                result.push(chapterQueues[chapter].shift());
            }
            return result;
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function displayQuestion() {
            const question = currentQuiz[currentQuestionIndex];
            const optionsGrid = document.getElementById('optionsGrid');
            const nextBtn = document.getElementById('nextBtn');
            
            document.getElementById('questionNum').textContent = currentQuestionIndex + 1;
            document.getElementById('currentScore').textContent = score;
            document.getElementById('russianWord').textContent = question.russian;
            
            // Update progress bar
            const progress = ((currentQuestionIndex + 1) / currentQuiz.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
            // Generate options
            const options = generateOptions(question);
            optionsGrid.innerHTML = '';
            
            options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option;
                optionElement.addEventListener('click', () => selectAnswer(option, question.vietnamese, optionElement));
                optionsGrid.appendChild(optionElement);
            });
            
            nextBtn.style.display = 'none';
        }

        function generateOptions(correctQuestion) {
            const options = [correctQuestion.vietnamese];
            const allWords = [];
            
            // Get all words from selected chapters
            selectedChapters.forEach(chapter => {
                vocabularyData[chapter].forEach(word => {
                    if (word.vietnamese !== correctQuestion.vietnamese) {
                        allWords.push(word.vietnamese);
                    }
                });
            });
            
            // Add 3 random wrong options
            const shuffled = shuffleArray(allWords);
            for (let i = 0; i < 3 && i < shuffled.length; i++) {
                options.push(shuffled[i]);
            }
            
            return shuffleArray(options);
        }

        function selectAnswer(selectedOption, correctAnswer, optionElement) {
            const allOptions = document.querySelectorAll('.option');
            const nextBtn = document.getElementById('nextBtn');
            
            // Disable all options
            allOptions.forEach(option => {
                option.style.pointerEvents = 'none';
                if (option.textContent === correctAnswer) {
                    option.classList.add('correct');
                }
            });
            
            if (selectedOption === correctAnswer) {
                score++;
                document.getElementById('currentScore').textContent = score;
            } else {
                optionElement.classList.add('incorrect');
                const wrongItem = {
                    russian: currentQuiz[currentQuestionIndex].russian,
                    correct: correctAnswer,
                    selected: selectedOption
                };
                wrongAnswers.push(wrongItem);
                addPersistentWrong(wrongItem);
            }
            
            nextBtn.style.display = 'inline-block';
            nextBtn.classList.add('pulse');
            setTimeout(() => nextBtn.classList.remove('pulse'), 600);
        }

        function nextQuestion() {
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= currentQuiz.length) {
                showResults();
            } else {
                displayQuestion();
            }
        }

        function showResults() {
            const finalScore = document.getElementById('finalScore');
            const scoreMessage = document.getElementById('scoreMessage');
            const wrongAnswersDiv = document.getElementById('wrongAnswers');
            
            const percentage = Math.round((score / currentQuiz.length) * 100);
            finalScore.textContent = `${score}/${currentQuiz.length} (${percentage}%)`;
            
            let message = '';
            if (percentage >= 90) {
                message = '🏆 Xuất sắc! Bạn đã thành thạo từ vựng này!';
            } else if (percentage >= 70) {
                message = '👏 Tốt lắm! Hãy tiếp tục luyện tập!';
            } else if (percentage >= 50) {
                message = '👍 Khá ổn! Bạn cần ôn tập thêm một chút.';
            } else {
                message = '💪 Hãy cố gắng hơn! Luyện tập nhiều hơn nhé!';
            }
            scoreMessage.textContent = message;
            
            // Show wrong answers
            if (wrongAnswers.length > 0) {
                let wrongHtml = '<h3 style="margin-bottom: 15px; color: #ff6b6b;">❌ Các câu trả lời sai:</h3>';
                wrongAnswers.forEach(item => {
                    wrongHtml += `
                        <div style="padding: 10px; margin: 10px 0; background: white; border-radius: 10px; border-left: 4px solid #ff6b6b;">
                            <strong style="color: #764ba2;">${item.russian}</strong><br>
                            <span style="color: #4CAF50;">✓ Đúng: ${item.correct}</span><br>
                            <span style="color: #ff6b6b;">✗ Bạn chọn: ${item.selected}</span>
                        </div>
                    `;
                });
                wrongAnswersDiv.innerHTML = wrongHtml;
            } else {
                wrongAnswersDiv.innerHTML = '<div style="text-align: center; color: #4CAF50; font-size: 1.2em;">🎉 Bạn đã trả lời đúng tất cả!</div>';
            }
            
            showSection('resultsSection');
        }

        function restartQuiz() {
            startSelectedQuiz();
        }

        function endQuiz() {
            if (confirm('Bạn có chắc chắn muốn kết thúc quiz?')) {
                showResults();
            }
        }

        // Initialize - Auto load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            showSection('uploadSection');
            loadDataFromFolder(); // Automatically load data when page loads
        });
    </script>
</body>
</html>